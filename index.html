<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- PWA è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#f8f8f6">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%234f46e5' width='100' height='100' rx='22'/><text y='68' x='50' text-anchor='middle' font-size='50'>ğŸš‡</text></svg>">
    <title>é€šå‹¤åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Noto Sans TC', -apple-system, sans-serif; }
        body { background: #f8f8f6; -webkit-tap-highlight-color: transparent; }

        .route-card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            overflow: hidden;
        }

        .expandable {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
        }
        .expandable.open {
            max-height: 800px;
            overflow: visible;
        }

        .num { font-variant-numeric: tabular-nums; }
        .tag-rent { background: #dbeafe; color: #1d4ed8; }
        .tag-return { background: #d1fae5; color: #047857; }
        .qty-good { color: #059669; }
        .qty-warn { color: #d97706; }
        .qty-bad { color: #dc2626; }

        @keyframes spin { to { transform: rotate(360deg); } }
        .spinning { animation: spin 1s linear infinite; }

        .urgent-pulse { animation: urgentBg 1.5s ease-in-out infinite; }
        @keyframes urgentBg {
            0%, 100% { background-color: #fff; }
            50% { background-color: #fef2f2; }
        }

        .offline-tag { background: #fef3c7; color: #92400e; }

        /* åˆ†äº«æŒ‰éˆ• */
        .share-btn {
            padding: 4px 10px;
            background: #eef2ff;
            color: #4f46e5;
            border-radius: 6px;
            font-size: 12px;
            transition: all 0.2s;
        }
        .share-btn:active { transform: scale(0.95); background: #c7d2fe; }

        /* Toast é€šçŸ¥ */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #1f2937;
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 100;
        }
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body class="min-h-screen pb-10">

<div class="max-w-lg mx-auto px-4 pt-6">

    <!-- æ™‚é–“ -->
    <header class="text-center mb-5">
        <p id="currentTime" class="text-4xl font-light num text-gray-800">--:--</p>
        <p id="currentDate" class="text-sm text-gray-400 mt-1"></p>
    </header>

    <!-- é›¢ç·šæç¤º -->
    <div id="offlineHint" class="hidden text-center mb-4">
        <span class="offline-tag text-xs px-3 py-1 rounded-full">âš  é›¢ç·šæ¨¡å¼</span>
        <span id="cacheTime" class="text-xs text-gray-400 ml-2"></span>
    </div>

    <!-- å¸¸ç”¨è·¯ç·š -->
    <div class="space-y-3" id="mainRoutes"></div>

    <!-- æ›´å¤šè·¯ç·š -->
    <div class="mt-4">
        <button onclick="toggleMore()" class="w-full text-center text-sm text-gray-400 py-2 flex items-center justify-center gap-1">
            <span id="moreLabel">é¡¯ç¤ºæ›´å¤šè·¯ç·š</span>
            <svg id="moreArrow" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
        </button>
        <div id="moreRoutes" class="space-y-3 hidden"></div>
    </div>

    <!-- é‡æ–°æ•´ç† -->
    <div class="mt-6 text-center">
        <button onclick="refreshData()" class="inline-flex items-center gap-2 px-5 py-2.5 bg-white rounded-full shadow text-gray-600 hover:shadow-md transition">
            <svg id="refreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            é‡æ–°æ•´ç†
        </button>
        <p id="updateTime" class="text-xs text-gray-300 mt-2"></p>
    </div>

</div>

<!-- Toast é€šçŸ¥ -->
<div id="toast" class="toast"></div>

<script>
const TDX_CLIENT_ID = 'gychen-2bab6175-02b4-4286';
const TDX_CLIENT_SECRET = 'b055ec7c-b999-4d4d-9c64-0172518974f6';
const CACHE_KEY = 'commute_v3';
const METRO_TIME = 10;

// ===== è·¯ç·šå®šç¾© =====
const MAIN_ROUTES = [
    {
        id: 'school-work',
        name: 'å­¸æ ¡ â†’ å…¬å¸',
        icon: 'ğŸ“', iconTo: 'ğŸ¢',
        stages: [
            {
                label: 'â‘  é¨åˆ°A6',
                rent: [{ name: 'æ˜å¿—ç§‘æŠ€å¤§å­¸', short: 'æ˜å¿—' }],
                return: [{ name: 'æ·é‹æ³°å±±è²´å’Œç«™', short: 'æ³°å±±è²´å’Œ' }]
            },
            { type: 'metro', from: 'A6', to: 'A8', dir: '0' },
            {
                label: 'â‘¡ é¨åˆ°å…¬å¸',
                rent: [
                    { name: 'æ·é‹é•·åºšé†«é™¢ç«™(A8)', short: 'A8ç«™' },
                    { name: 'æ·é‹é•·åºšé†«é™¢ç«™(A8)æ±å´', short: 'A8æ±å´' }
                ],
                return: [{ name: 'å¾©èˆˆä¸‰å¾©èˆˆå—è·¯å£', short: 'å¾©èˆˆä¸‰è·¯' }]
            }
        ]
    },
    {
        id: 'dorm-school',
        name: 'å®¿èˆ â†’ å­¸æ ¡',
        icon: 'ğŸ ', iconTo: 'ğŸ“',
        stages: [
            {
                label: 'â‘  é¨åˆ°A8',
                rent: [{ name: 'æ–‡èˆˆå…¬åœ’', short: 'æ–‡èˆˆå…¬åœ’' }],
                return: [
                    { name: 'æ·é‹é•·åºšé†«é™¢ç«™(A8)', short: 'A8ç«™' },
                    { name: 'æ·é‹é•·åºšé†«é™¢ç«™(A8)æ±å´', short: 'A8æ±å´' }
                ]
            },
            { type: 'metro', from: 'A8', to: 'A6', dir: '1' },
            {
                label: 'â‘¡ é¨åˆ°å­¸æ ¡',
                rent: [{ name: 'æ·é‹æ³°å±±è²´å’Œç«™', short: 'æ³°å±±è²´å’Œ' }],
                return: [{ name: 'æ˜å¿—ç§‘æŠ€å¤§å­¸', short: 'æ˜å¿—' }]
            }
        ]
    },
    {
        id: 'work-school',
        name: 'å…¬å¸ â†’ å­¸æ ¡',
        icon: 'ğŸ¢', iconTo: 'ğŸ“',
        stages: [
            {
                label: 'â‘  é¨åˆ°A8',
                rent: [{ name: 'å¾©èˆˆä¸‰å¾©èˆˆå—è·¯å£', short: 'å¾©èˆˆä¸‰è·¯' }],
                return: [
                    { name: 'æ·é‹é•·åºšé†«é™¢ç«™(A8)', short: 'A8ç«™' },
                    { name: 'æ·é‹é•·åºšé†«é™¢ç«™(A8)æ±å´', short: 'A8æ±å´' }
                ]
            },
            { type: 'metro', from: 'A8', to: 'A6', dir: '1' },
            {
                label: 'â‘¡ é¨åˆ°å­¸æ ¡',
                rent: [{ name: 'æ·é‹æ³°å±±è²´å’Œç«™', short: 'æ³°å±±è²´å’Œ' }],
                return: [{ name: 'æ˜å¿—ç§‘æŠ€å¤§å­¸', short: 'æ˜å¿—' }]
            }
        ]
    }
];

const MORE_ROUTES = [
    {
        id: 'dorm-work',
        name: 'å®¿èˆ â†’ å…¬å¸',
        icon: 'ğŸ ', iconTo: 'ğŸ¢',
        bikeOnly: true, bikeTime: 15,
        stages: [
            {
                label: 'ğŸš² ç›´æ¥é¨è»Š',
                rent: [{ name: 'æ–‡èˆˆå…¬åœ’', short: 'æ–‡èˆˆå…¬åœ’' }],
                return: [{ name: 'å¾©èˆˆä¸‰å¾©èˆˆå—è·¯å£', short: 'å¾©èˆˆä¸‰è·¯' }]
            }
        ]
    },
    {
        id: 'work-dorm',
        name: 'å…¬å¸ â†’ å®¿èˆ',
        icon: 'ğŸ¢', iconTo: 'ğŸ ',
        bikeOnly: true, bikeTime: 15,
        stages: [
            {
                label: 'ğŸš² ç›´æ¥é¨è»Š',
                rent: [{ name: 'å¾©èˆˆä¸‰å¾©èˆˆå—è·¯å£', short: 'å¾©èˆˆä¸‰è·¯' }],
                return: [{ name: 'æ–‡èˆˆå…¬åœ’', short: 'æ–‡èˆˆå…¬åœ’' }]
            }
        ]
    }
];

let accessToken = null;
let tokenExpiry = null;
let cache = { metro: null, stations: null, avail: null, time: null };
let moreVisible = false;

// ===== åˆå§‹åŒ– =====
document.addEventListener('DOMContentLoaded', () => {
    updateClock();
    setInterval(updateClock, 1000);
    setInterval(updateAllRoutes, 1000);
    loadCache();
    renderAllCards();
    refreshData();
});

function updateClock() {
    const now = new Date();
    document.getElementById('currentTime').textContent =
        now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
    document.getElementById('currentDate').textContent =
        now.toLocaleDateString('zh-TW', { month: 'short', day: 'numeric', weekday: 'short' });
}

// ===== å¡ç‰‡æ¸²æŸ“ =====
function renderAllCards() {
    document.getElementById('mainRoutes').innerHTML = MAIN_ROUTES.map(r => createCardHTML(r)).join('');
    document.getElementById('moreRoutes').innerHTML = MORE_ROUTES.map(r => createCardHTML(r)).join('');
}

function createCardHTML(route) {
    return `
        <div class="route-card" id="card-${route.id}">
            <div class="p-4 cursor-pointer" onclick="toggleCard('${route.id}')">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <span class="text-xl">${route.icon}</span>
                        <span class="text-gray-300">â†’</span>
                        <span class="text-xl">${route.iconTo}</span>
                        <span class="text-sm font-medium text-gray-700 ml-1">${route.name}</span>
                    </div>
                    <svg id="arrow-${route.id}" class="w-5 h-5 text-gray-300 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>
                <div id="summary-${route.id}" class="text-gray-400 text-sm">è¼‰å…¥ä¸­...</div>
            </div>
            <div id="detail-${route.id}" class="expandable">
                <div class="border-t border-gray-100 p-4" id="detailContent-${route.id}"></div>
            </div>
        </div>
    `;
}

function toggleCard(id) {
    const detail = document.getElementById(`detail-${id}`);
    const arrow = document.getElementById(`arrow-${id}`);
    const isOpen = detail.classList.toggle('open');
    arrow.style.transform = isOpen ? 'rotate(180deg)' : '';
}

function toggleMore() {
    moreVisible = !moreVisible;
    document.getElementById('moreRoutes').classList.toggle('hidden', !moreVisible);
    document.getElementById('moreLabel').textContent = moreVisible ? 'æ”¶èµ·æ›´å¤šè·¯ç·š' : 'é¡¯ç¤ºæ›´å¤šè·¯ç·š';
    document.getElementById('moreArrow').style.transform = moreVisible ? 'rotate(180deg)' : '';
}

// ===== å¿«å– =====
function loadCache() {
    try {
        const saved = localStorage.getItem(CACHE_KEY);
        if (saved) cache = JSON.parse(saved);
    } catch (e) {}
}

function saveCache() {
    try { localStorage.setItem(CACHE_KEY, JSON.stringify(cache)); } catch (e) {}
}

// ===== API =====
async function getToken() {
    if (accessToken && tokenExpiry && new Date() < tokenExpiry) return accessToken;
    const res = await fetch('https://tdx.transportdata.tw/auth/realms/TDXConnect/protocol/openid-connect/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
            grant_type: 'client_credentials',
            client_id: TDX_CLIENT_ID,
            client_secret: TDX_CLIENT_SECRET
        })
    });
    if (!res.ok) throw new Error('èªè­‰å¤±æ•—');
    const data = await res.json();
    accessToken = data.access_token;
    tokenExpiry = new Date(Date.now() + (data.expires_in - 300) * 1000);
    return accessToken;
}

async function fetchAPI(token, url) {
    const res = await fetch(url + '?$format=JSON', { headers: { 'Authorization': `Bearer ${token}` } });
    return res.json();
}

async function refreshData() {
    document.getElementById('refreshIcon').classList.add('spinning');

    try {
        const token = await getToken();
        const [metro, ntS, tyS, ntA, tyA] = await Promise.all([
            fetchAPI(token, 'https://tdx.transportdata.tw/api/basic/v2/Rail/Metro/StationTimeTable/TYMC'),
            fetchAPI(token, 'https://tdx.transportdata.tw/api/basic/v2/Bike/Station/City/NewTaipei'),
            fetchAPI(token, 'https://tdx.transportdata.tw/api/basic/v2/Bike/Station/City/Taoyuan'),
            fetchAPI(token, 'https://tdx.transportdata.tw/api/basic/v2/Bike/Availability/City/NewTaipei'),
            fetchAPI(token, 'https://tdx.transportdata.tw/api/basic/v2/Bike/Availability/City/Taoyuan')
        ]);
        cache = { metro, stations: [...ntS, ...tyS], avail: [...ntA, ...tyA], time: Date.now() };
        saveCache();
        document.getElementById('offlineHint').classList.add('hidden');
        document.getElementById('updateTime').textContent = `æ›´æ–°æ–¼ ${formatTime(new Date())}`;
    } catch (e) {
        console.error(e);
        if (cache.time) {
            document.getElementById('offlineHint').classList.remove('hidden');
            document.getElementById('cacheTime').textContent = `(${formatTimeAgo(cache.time)})`;
        }
    }

    updateAllRoutes();
    document.getElementById('refreshIcon').classList.remove('spinning');
}

function updateAllRoutes() {
    if (!cache.metro) return;
    [...MAIN_ROUTES, ...MORE_ROUTES].forEach(route => updateRouteDisplay(route));
}

// ===== è³‡æ–™è™•ç† =====
function getNextTrains(from, to, dir, limit = 5) {
    const now = new Date();
    const currentMins = now.getHours() * 60 + now.getMinutes();
    const isWeekend = now.getDay() === 0 || now.getDay() === 6;
    const serviceTag = isWeekend ? 'å‡æ—¥' : 'å¹³æ—¥';

    const stationData = cache.metro.filter(item =>
        item.StationID === from &&
        String(item.Direction) === dir &&
        item.ServiceDay?.ServiceTag === serviceTag
    );

    const trains = [];
    stationData.forEach(route => {
        const dest = route.DestinationStationName?.Zh_tw || '';
        const isExpress = dest === 'è‡ºåŒ—è»Šç«™' || dest === 'A1';

        route.Timetables.forEach(tt => {
            const [h, m] = tt.DepartureTime.split(':').map(Number);
            let mins = h * 60 + m;
            if (mins < currentMins - 180) mins += 1440;
            trains.push({ time: tt.DepartureTime, mins, isExpress, dest });
        });
    });

    trains.sort((a, b) => a.mins - b.mins);
    const needFilter = (from === 'A6' || to === 'A6');
    const filtered = needFilter ? trains.filter(t => !t.isExpress) : trains;
    return filtered.filter(t => t.mins >= currentMins).slice(0, limit);
}

function getBikeValue(stationName, type) {
    const station = cache.stations?.find(s => s.StationName?.Zh_tw?.includes(stationName));
    if (!station) return null;
    const avail = cache.avail?.find(a => a.StationUID === station.StationUID);
    return type === 'rent' ? (avail?.AvailableRentBikes ?? 0) : (avail?.AvailableReturnBikes ?? 0);
}

function qtyClass(n) {
    if (n === 0) return 'qty-bad';
    if (n <= 3) return 'qty-warn';
    return 'qty-good';
}

// ===== é¡¯ç¤ºæ›´æ–° =====
function updateRouteDisplay(route) {
    const now = new Date();
    const currentMins = now.getHours() * 60 + now.getMinutes();
    const summaryEl = document.getElementById(`summary-${route.id}`);
    const detailEl = document.getElementById(`detailContent-${route.id}`);
    const cardEl = document.getElementById(`card-${route.id}`);
    if (!summaryEl || !detailEl) return;

    const metroStage = route.stages.find(s => s.type === 'metro');
    let nextTrain = null, countdown = null;

    if (metroStage) {
        const trains = getNextTrains(metroStage.from, metroStage.to, metroStage.dir);
        if (trains.length > 0) {
            nextTrain = trains[0];
            countdown = nextTrain.mins - currentMins;
        }
    }

    const bikeStages = route.stages.filter(s => !s.type);

    // ===== æ‘˜è¦ =====
    let summaryHTML = '';

    if (route.bikeOnly) {
        const stage = bikeStages[0];
        const rentVal = getBikeValue(stage.rent[0].name, 'rent') ?? 0;
        const retVal = getBikeValue(stage.return[0].name, 'return') ?? 0;

        summaryHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-1">
                        <span class="tag-rent text-xs px-2 py-0.5 rounded">å€Ÿ</span>
                        <span class="text-base font-bold num ${qtyClass(rentVal)}">${rentVal}</span>
                        <span class="text-xs text-gray-400">${stage.rent[0].short}</span>
                    </div>
                    <span class="text-gray-300">â†’</span>
                    <div class="flex items-center gap-1">
                        <span class="tag-return text-xs px-2 py-0.5 rounded">é‚„</span>
                        <span class="text-base font-bold num ${qtyClass(retVal)}">${retVal}</span>
                        <span class="text-xs text-gray-400">${stage.return[0].short}</span>
                    </div>
                </div>
                <span class="text-sm text-gray-400">ğŸš² ${route.bikeTime}åˆ†</span>
            </div>
        `;
    } else {
        const isUrgent = countdown !== null && countdown <= 3;
        if (isUrgent) {
            cardEl.classList.add('urgent-pulse');
            triggerVibration();
        } else {
            cardEl.classList.remove('urgent-pulse');
        }

        // å„éšæ®µæ‘˜è¦ - åˆ†é–‹é¡¯ç¤ºæ¯å€‹ç«™é»
        const stagesSummary = bikeStages.map((stage, idx) => {
            const stageNum = idx === 0 ? 'â‘ ' : 'â‘¡';

            // å€Ÿè»Šç«™é»ï¼ˆåˆ†é–‹é¡¯ç¤ºï¼‰
            const rentItems = stage.rent.map(s => {
                const val = getBikeValue(s.name, 'rent') ?? 0;
                return `<span class="tag-rent text-xs px-1 py-0.5 rounded" title="${s.short}">${s.short.replace('ç«™','')}<b class="${qtyClass(val)}">${val}</b></span>`;
            }).join('');

            // é‚„è»Šç«™é»ï¼ˆé€šå¸¸åªæœ‰ä¸€å€‹ï¼Œé¡¯ç¤ºåˆè¨ˆï¼‰
            const retTotal = stage.return.reduce((sum, s) => sum + (getBikeValue(s.name, 'return') ?? 0), 0);

            return `
                <div class="flex items-center gap-1 flex-wrap">
                    <span class="text-xs text-gray-400">${stageNum}</span>
                    ${rentItems}
                    <span class="text-gray-300 text-xs">â†’</span>
                    <span class="tag-return text-xs px-1.5 py-0.5 rounded">${retTotal}</span>
                </div>
            `;
        }).join('<span class="text-gray-200 mx-0.5">|</span>');

        summaryHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center">${stagesSummary}</div>
                <div class="text-right">
                    ${nextTrain ? `
                        <span class="text-lg font-bold num ${isUrgent ? 'text-red-500' : 'text-gray-800'}">${nextTrain.time}</span>
                        <span class="text-sm ${isUrgent ? 'text-red-400' : 'text-gray-400'} ml-1">${countdown}åˆ†</span>
                    ` : '<span class="text-sm text-gray-400">ç„¡ç­æ¬¡</span>'}
                </div>
            </div>
        `;
    }

    summaryEl.innerHTML = summaryHTML;

    // ===== è©³ç´°å…§å®¹ =====
    let detailHTML = '';

    // æ·é‹ç­æ¬¡ï¼ˆå«åˆ†äº«æŒ‰éˆ•ï¼‰
    if (metroStage) {
        const trains = getNextTrains(metroStage.from, metroStage.to, metroStage.dir, 5);
        const arriveStation = metroStage.to;

        detailHTML += `
            <div class="mb-4">
                <div class="text-xs font-medium text-gray-500 mb-2">ğŸš‡ æ·é‹ ${metroStage.from} â†’ ${metroStage.to}</div>
                ${trains.length > 0 ? `
                    <div class="space-y-1">
                        ${trains.map((t, i) => {
                            const diff = t.mins - currentMins;
                            const arriveTime = formatMinsToTime(t.mins + METRO_TIME);
                            const shareData = encodeURIComponent(JSON.stringify({
                                route: route.name,
                                from: metroStage.from,
                                to: metroStage.to,
                                depart: t.time,
                                arrive: arriveTime
                            }));
                            return `
                                <div class="flex justify-between items-center py-2 px-2 ${i === 0 ? 'bg-gray-50 rounded' : 'border-b border-gray-50'}">
                                    <div>
                                        <span class="num ${i === 0 ? 'font-medium text-base' : 'text-gray-500'}">${t.time}</span>
                                        <span class="text-xs text-gray-400 ml-2">â†’ ${arriveTime} åˆ°${arriveStation}</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-sm ${diff <= 3 ? 'text-red-500 font-medium' : diff <= 5 ? 'text-amber-500' : 'text-gray-400'}">${diff}åˆ†</span>
                                        <button class="share-btn" onclick="shareTrain('${shareData}')">åˆ†äº«</button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                ` : '<div class="text-gray-400 text-sm">ä»Šæ—¥å·²ç„¡ç­æ¬¡</div>'}
            </div>
        `;
    }

    // YouBike å„éšæ®µè©³ç´°
    bikeStages.forEach(stage => {
        detailHTML += `
            <div class="mb-4">
                <div class="text-xs font-medium text-gray-500 mb-2">${stage.label}</div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <div class="text-xs text-blue-600 font-medium mb-1">å€Ÿè»Š</div>
                        ${stage.rent.map(s => {
                            const val = getBikeValue(s.name, 'rent') ?? 0;
                            return `
                                <div class="bg-blue-50 p-2 rounded mb-1">
                                    <div class="text-xs text-gray-600">${s.short}</div>
                                    <div class="text-xl font-bold num ${qtyClass(val)}">${val}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div>
                        <div class="text-xs text-emerald-600 font-medium mb-1">é‚„è»Š</div>
                        ${stage.return.map(s => {
                            const val = getBikeValue(s.name, 'return') ?? 0;
                            return `
                                <div class="bg-emerald-50 p-2 rounded mb-1">
                                    <div class="text-xs text-gray-600">${s.short}</div>
                                    <div class="text-xl font-bold num ${qtyClass(val)}">${val}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>
        `;
    });

    detailEl.innerHTML = detailHTML;
}

// ===== å·¥å…· =====
function formatTime(d) {
    return d.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });
}

function formatMinsToTime(mins) {
    const h = Math.floor(mins / 60) % 24;
    const m = mins % 60;
    return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
}

function formatTimeAgo(ts) {
    const mins = Math.floor((Date.now() - ts) / 60000);
    if (mins < 1) return 'å‰›å‰›';
    if (mins < 60) return `${mins}åˆ†é˜å‰`;
    return `${Math.floor(mins / 60)}å°æ™‚å‰`;
}

function triggerVibration() {
    if ('vibrate' in navigator) navigator.vibrate([100, 50, 100]);
}

// ===== åˆ†äº«åŠŸèƒ½ =====
async function shareTrain(encodedData) {
    const data = JSON.parse(decodeURIComponent(encodedData));
    const today = new Date().toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric' });

    const text = `ğŸš‡ é€šå‹¤è³‡è¨Š (${today})
â”â”â”â”â”â”â”â”â”â”
ğŸ“ ${data.route}
ğŸ• ${data.depart} å¾ ${data.from} ç«™ç™¼è»Š
ğŸ¯ é è¨ˆ ${data.arrive} æŠµé” ${data.to} ç«™
â”â”â”â”â”â”â”â”â”â”
æœ‰ç©ºçš„è©±å¯ä»¥ä¾†æ¥æˆ‘ï½`;

    // å˜—è©¦ä½¿ç”¨ Web Share API
    if (navigator.share) {
        try {
            await navigator.share({ text });
            showToast('âœ“ å·²é–‹å•Ÿåˆ†äº«');
            return;
        } catch (e) {
            if (e.name !== 'AbortError') {
                console.log('Share failed, fallback to clipboard');
            } else {
                return; // ä½¿ç”¨è€…å–æ¶ˆåˆ†äº«
            }
        }
    }

    // Fallback: è¤‡è£½åˆ°å‰ªè²¼ç°¿
    try {
        await navigator.clipboard.writeText(text);
        showToast('âœ“ å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
    } catch (e) {
        // æœ€å¾Œæ‰‹æ®µï¼šé¸å–æ–‡å­—
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showToast('âœ“ å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
    }
}

function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2000);
}
</script>
</body>
</html>
