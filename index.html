<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f5f5f7">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%234f46e5' width='100' height='100' rx='22'/><text y='68' x='50' text-anchor='middle' font-size='50'>ğŸš‡</text></svg>">
    <title>é€šå‹¤åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700&display=swap');

        * {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        body {
            background: linear-gradient(180deg, #e8e8ed 0%, #f5f5f7 50%, #e8e8ed 100%);
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        /* iOS 26 æ¶²æ…‹ç»ç’ƒå¡ç‰‡ */
        .glass-card {
            background: rgba(255, 255, 255, 0.72);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 22px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow:
                0 1px 3px rgba(0,0,0,0.04),
                0 8px 24px rgba(0,0,0,0.08);
        }

        /* å‹•æ…‹å³¶é¢¨æ ¼æŒ‰éˆ• */
        .pill-btn {
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(10px);
            border-radius: 50px;
            color: white;
            transition: all 0.2s ease;
        }
        .pill-btn:active {
            transform: scale(0.97);
            background: rgba(0, 0, 0, 0.85);
        }

        /* æ¨™ç±¤æ¨£å¼ */
        .tag-rent {
            background: rgba(59, 130, 246, 0.15);
            color: #2563eb;
            border-radius: 8px;
        }
        .tag-return {
            background: rgba(16, 185, 129, 0.15);
            color: #059669;
            border-radius: 8px;
        }

        /* æ•¸é‡é¡è‰² */
        .qty-good { color: #059669; }
        .qty-warn { color: #f59e0b; }
        .qty-bad { color: #ef4444; }

        /* å±•é–‹å‹•ç•« */
        .expandable {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .expandable.open { max-height: 800px; }

        /* è¼‰å…¥å‹•ç•« */
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinning { animation: spin 1s linear infinite; }

        /* ç·Šæ€¥é–ƒçˆ */
        .urgent-pulse {
            animation: urgentGlow 2s ease-in-out infinite;
        }
        @keyframes urgentGlow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
            50% { box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.3); }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            color: white;
            padding: 14px 24px;
            border-radius: 50px;
            font-size: 15px;
            font-weight: 500;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
        }
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* åˆ†äº«æŒ‰éˆ• */
        .share-btn {
            background: rgba(99, 102, 241, 0.12);
            color: #6366f1;
            padding: 6px 12px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
        }

        /* æ•¸å­—ç­‰å¯¬ */
        .num { font-variant-numeric: tabular-nums; }

        /* å®šä½çµæœ */
        .location-pill {
            background: rgba(99, 102, 241, 0.12);
            color: #6366f1;
            border-radius: 50px;
            padding: 6px 14px;
            font-size: 13px;
            font-weight: 500;
        }
    </style>
</head>
<body class="pb-10">

<div class="max-w-lg mx-auto px-4 pt-8">

    <!-- å®šä½çµæœç½®é ‚æç¤º -->
    <div id="locationBanner" class="hidden mb-4">
        <div class="glass-card p-4 flex items-center justify-between bg-indigo-50/80">
            <div class="flex items-center gap-2">
                <span class="text-xl">ğŸ“</span>
                <span id="bannerLocation" class="font-medium text-indigo-700"></span>
            </div>
            <button onclick="closeBanner()" class="text-indigo-400 hover:text-indigo-600 p-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- æ™‚é–“ -->
    <header class="text-center mb-6">
        <p id="currentTime" class="text-5xl font-light num text-gray-800 tracking-tight">--:--:--</p>
        <p id="currentDate" class="text-base text-gray-500 mt-2"></p>
    </header>

    <!-- å®šä½æŒ‰éˆ• -->
    <div class="mb-5">
        <button onclick="autoLocate()" id="locateBtn" class="pill-btn w-full py-4 flex items-center justify-center gap-3 text-base font-medium">
            <svg id="locateIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            <span id="locateText">è‡ªå‹•å®šä½</span>
        </button>
    </div>

    <!-- ç›®æ¨™ç­æ¬¡ -->
    <div id="targetBanner" class="hidden mb-4">
        <div class="glass-card p-4 bg-amber-50/80 border-amber-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">ğŸ¯</span>
                    <div>
                        <div class="text-xs text-amber-600 font-medium">ç›®æ¨™ç­æ¬¡</div>
                        <div id="targetInfo" class="font-semibold text-gray-800"></div>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="text-right">
                        <div id="targetCountdown" class="text-2xl font-bold num text-amber-600"></div>
                        <div class="text-xs text-gray-500">åˆ†é˜å¾Œ</div>
                    </div>
                    <button onclick="clearTarget()" class="text-amber-400 hover:text-amber-600 p-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- é›¢ç·šæç¤º -->
    <div id="offlineHint" class="hidden text-center mb-4">
        <span class="location-pill bg-amber-100 text-amber-700">âš  é›¢ç·šæ¨¡å¼</span>
        <span id="cacheTime" class="text-xs text-gray-400 ml-2"></span>
    </div>

    <!-- å¸¸ç”¨è·¯ç·š -->
    <div class="space-y-4" id="mainRoutes"></div>

    <!-- æ›´å¤šè·¯ç·š -->
    <div class="mt-5">
        <button onclick="toggleMore()" class="w-full text-center text-sm text-gray-400 py-3 flex items-center justify-center gap-2">
            <span id="moreLabel">æ›´å¤šè·¯ç·š</span>
            <svg id="moreArrow" class="w-4 h-4 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
        </button>
        <div id="moreRoutes" class="space-y-4 hidden mt-2"></div>
    </div>

    <!-- é‡æ–°æ•´ç† -->
    <div class="mt-8 text-center">
        <button onclick="refreshData()" class="inline-flex items-center gap-2 px-6 py-3 glass-card text-gray-600 font-medium">
            <svg id="refreshIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            é‡æ–°æ•´ç†
        </button>
        <p id="updateTime" class="text-xs text-gray-400 mt-3"></p>
    </div>

</div>

<div id="toast" class="toast"></div>

<!-- é ‚éƒ¨ç·Šæ€¥æé†’ -->
<div id="urgentAlert" class="fixed top-0 left-0 right-0 z-50 transform -translate-y-full transition-transform duration-300">
    <div class="max-w-lg mx-auto px-4 pt-2">
        <div class="bg-red-500/95 backdrop-blur-lg text-white px-5 py-3 rounded-b-2xl shadow-lg flex items-center justify-between">
            <div class="flex items-center gap-2">
                <span class="text-lg">ğŸš¨</span>
                <span id="urgentText" class="font-medium"></span>
            </div>
            <button onclick="hideUrgentAlert()" class="text-white/80 hover:text-white p-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
    </div>
</div>

<script>
const TDX_CLIENT_ID = 'gychen-2bab6175-02b4-4286';
const TDX_CLIENT_SECRET = 'b055ec7c-b999-4d4d-9c64-0172518974f6';
const CACHE_KEY = 'commute_v4';
const METRO_TIME = 10;

const LOCATIONS = {
    school: { name: 'å­¸æ ¡', lat: 25.04099822064754, lng: 121.42230160324743 },
    a6: { name: 'A6ç«™', lat: 25.033223516811884, lng: 121.42262992980059 },
    a8: { name: 'A8ç«™', lat: 25.06053376174861, lng: 121.3707347497086 },
    dorm: { name: 'å®¿èˆ', lat: 25.05490831481167, lng: 121.37008743186047 },
    work: { name: 'å…¬å¸', lat: 25.051970647450528, lng: 121.37421893051638 }
};

const LOCATION_ROUTES = {
    school: ['school-work'],
    dorm: ['dorm-school', 'dorm-work'],
    work: ['work-school', 'work-dorm'],
    a6: ['school-work'],
    a8: ['work-school', 'dorm-school']
};

const MAIN_ROUTES = [
    {
        id: 'school-work',
        name: 'å­¸æ ¡ â†’ å…¬å¸',
        icon: 'ğŸ“', iconTo: 'ğŸ¢',
        stages: [
            { label: 'â‘  é¨åˆ°A6', rent: [{ name: 'æ˜å¿—ç§‘æŠ€å¤§å­¸', short: 'æ˜å¿—' }], return: [{ name: 'æ·é‹æ³°å±±è²´å’Œç«™', short: 'æ³°å±±è²´å’Œ' }] },
            { type: 'metro', from: 'A6', to: 'A8', dir: '0' },
            { label: 'â‘¡ é¨åˆ°å…¬å¸', rent: [{ name: 'æ·é‹é•·åºšé†«é™¢ç«™(A8)', short: 'A8' }, { name: 'æ·é‹é•·åºšé†«é™¢ç«™(A8)æ±å´', short: 'A8æ±' }], return: [{ name: 'å¾©èˆˆä¸‰å¾©èˆˆå—è·¯å£', short: 'å¾©èˆˆä¸‰è·¯' }] }
        ]
    },
    {
        id: 'dorm-school',
        name: 'å®¿èˆ â†’ å­¸æ ¡',
        icon: 'ğŸ ', iconTo: 'ğŸ“',
        stages: [
            { label: 'â‘  é¨åˆ°A8', rent: [{ name: 'æ–‡èˆˆå…¬åœ’', short: 'æ–‡èˆˆå…¬åœ’' }], return: [{ name: 'æ·é‹é•·åºšé†«é™¢ç«™(A8)', short: 'A8' }, { name: 'æ·é‹é•·åºšé†«é™¢ç«™(A8)æ±å´', short: 'A8æ±' }] },
            { type: 'metro', from: 'A8', to: 'A6', dir: '1' },
            { label: 'â‘¡ é¨åˆ°å­¸æ ¡', rent: [{ name: 'æ·é‹æ³°å±±è²´å’Œç«™', short: 'æ³°å±±è²´å’Œ' }], return: [{ name: 'æ˜å¿—ç§‘æŠ€å¤§å­¸', short: 'æ˜å¿—' }] }
        ]
    },
    {
        id: 'work-school',
        name: 'å…¬å¸ â†’ å­¸æ ¡',
        icon: 'ğŸ¢', iconTo: 'ğŸ“',
        stages: [
            { label: 'â‘  é¨åˆ°A8', rent: [{ name: 'å¾©èˆˆä¸‰å¾©èˆˆå—è·¯å£', short: 'å¾©èˆˆä¸‰è·¯' }], return: [{ name: 'æ·é‹é•·åºšé†«é™¢ç«™(A8)', short: 'A8' }, { name: 'æ·é‹é•·åºšé†«é™¢ç«™(A8)æ±å´', short: 'A8æ±' }] },
            { type: 'metro', from: 'A8', to: 'A6', dir: '1' },
            { label: 'â‘¡ é¨åˆ°å­¸æ ¡', rent: [{ name: 'æ·é‹æ³°å±±è²´å’Œç«™', short: 'æ³°å±±è²´å’Œ' }], return: [{ name: 'æ˜å¿—ç§‘æŠ€å¤§å­¸', short: 'æ˜å¿—' }] }
        ]
    }
];

const MORE_ROUTES = [
    {
        id: 'dorm-work',
        name: 'å®¿èˆ â†’ å…¬å¸',
        icon: 'ğŸ ', iconTo: 'ğŸ¢',
        bikeOnly: true, bikeTime: 15,
        stages: [{ label: 'ğŸš² ç›´æ¥é¨è»Š', rent: [{ name: 'æ–‡èˆˆå…¬åœ’', short: 'æ–‡èˆˆå…¬åœ’' }], return: [{ name: 'å¾©èˆˆä¸‰å¾©èˆˆå—è·¯å£', short: 'å¾©èˆˆä¸‰è·¯' }] }]
    },
    {
        id: 'work-dorm',
        name: 'å…¬å¸ â†’ å®¿èˆ',
        icon: 'ğŸ¢', iconTo: 'ğŸ ',
        bikeOnly: true, bikeTime: 15,
        stages: [{ label: 'ğŸš² ç›´æ¥é¨è»Š', rent: [{ name: 'å¾©èˆˆä¸‰å¾©èˆˆå—è·¯å£', short: 'å¾©èˆˆä¸‰è·¯' }], return: [{ name: 'æ–‡èˆˆå…¬åœ’', short: 'æ–‡èˆˆå…¬åœ’' }] }]
    }
];

let accessToken = null, tokenExpiry = null;
let cache = { metro: null, stations: null, avail: null, time: null };
let moreVisible = false;
let targetTrain = null; // { routeId, time, routeName }

document.addEventListener('DOMContentLoaded', () => {
    updateClock();
    setInterval(updateClock, 1000);
    setInterval(() => {
        updateAllRoutes();
        updateTargetBanner();
    }, 1000);
    loadCache();
    renderAllCards();
    refreshData();
});

function updateClock() {
    const now = new Date();
    document.getElementById('currentTime').textContent = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
    document.getElementById('currentDate').textContent = now.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
}

function renderAllCards() {
    document.getElementById('mainRoutes').innerHTML = MAIN_ROUTES.map(r => createCardHTML(r)).join('');
    document.getElementById('moreRoutes').innerHTML = MORE_ROUTES.map(r => createCardHTML(r)).join('');
}

function createCardHTML(route) {
    return `
        <div class="glass-card" id="card-${route.id}">
            <div class="p-5 cursor-pointer" onclick="toggleCard('${route.id}')">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-1.5 text-base">
                        <span class="font-semibold text-gray-800">${route.name.split(' â†’ ')[0]}</span>
                        <span class="text-xl">${route.icon}</span>
                        <span class="text-gray-300 mx-1">â†’</span>
                        <span class="font-semibold text-gray-800">${route.name.split(' â†’ ')[1]}</span>
                        <span class="text-xl">${route.iconTo}</span>
                    </div>
                    <svg id="arrow-${route.id}" class="w-5 h-5 text-gray-400 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>
                <div id="summary-${route.id}" class="text-gray-500 text-sm">è¼‰å…¥ä¸­...</div>
            </div>
            <div id="detail-${route.id}" class="expandable">
                <div class="border-t border-gray-200/50 p-5" id="detailContent-${route.id}"></div>
            </div>
        </div>
    `;
}

function toggleCard(id) {
    const detail = document.getElementById(`detail-${id}`);
    const arrow = document.getElementById(`arrow-${id}`);
    detail.classList.toggle('open');
    arrow.style.transform = detail.classList.contains('open') ? 'rotate(180deg)' : '';
}

function toggleMore() {
    moreVisible = !moreVisible;
    document.getElementById('moreRoutes').classList.toggle('hidden', !moreVisible);
    document.getElementById('moreLabel').textContent = moreVisible ? 'æ”¶èµ·' : 'æ›´å¤šè·¯ç·š';
    document.getElementById('moreArrow').style.transform = moreVisible ? 'rotate(180deg)' : '';
}

function loadCache() { try { const s = localStorage.getItem(CACHE_KEY); if (s) cache = JSON.parse(s); } catch(e) {} }
function saveCache() { try { localStorage.setItem(CACHE_KEY, JSON.stringify(cache)); } catch(e) {} }

async function getToken() {
    if (accessToken && tokenExpiry && new Date() < tokenExpiry) return accessToken;
    const res = await fetch('https://tdx.transportdata.tw/auth/realms/TDXConnect/protocol/openid-connect/token', {
        method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ grant_type: 'client_credentials', client_id: TDX_CLIENT_ID, client_secret: TDX_CLIENT_SECRET })
    });
    const data = await res.json();
    accessToken = data.access_token;
    tokenExpiry = new Date(Date.now() + (data.expires_in - 300) * 1000);
    return accessToken;
}

async function fetchAPI(token, url) {
    const res = await fetch(url + '?$format=JSON', { headers: { 'Authorization': `Bearer ${token}` } });
    return res.json();
}

async function refreshData() {
    document.getElementById('refreshIcon').classList.add('spinning');
    try {
        const token = await getToken();
        const [metro, ntS, tyS, ntA, tyA] = await Promise.all([
            fetchAPI(token, 'https://tdx.transportdata.tw/api/basic/v2/Rail/Metro/StationTimeTable/TYMC'),
            fetchAPI(token, 'https://tdx.transportdata.tw/api/basic/v2/Bike/Station/City/NewTaipei'),
            fetchAPI(token, 'https://tdx.transportdata.tw/api/basic/v2/Bike/Station/City/Taoyuan'),
            fetchAPI(token, 'https://tdx.transportdata.tw/api/basic/v2/Bike/Availability/City/NewTaipei'),
            fetchAPI(token, 'https://tdx.transportdata.tw/api/basic/v2/Bike/Availability/City/Taoyuan')
        ]);
        cache = { metro, stations: [...ntS, ...tyS], avail: [...ntA, ...tyA], time: Date.now() };
        saveCache();
        document.getElementById('offlineHint').classList.add('hidden');
        document.getElementById('updateTime').textContent = `æ›´æ–°æ–¼ ${formatTime(new Date())}`;
    } catch (e) {
        if (cache.time) {
            document.getElementById('offlineHint').classList.remove('hidden');
            document.getElementById('cacheTime').textContent = `(${formatTimeAgo(cache.time)})`;
        }
    }
    updateAllRoutes();
    document.getElementById('refreshIcon').classList.remove('spinning');
}

function updateAllRoutes() {
    if (!cache.metro) return;
    [...MAIN_ROUTES, ...MORE_ROUTES].forEach(route => updateRouteDisplay(route));
}

function getNextTrains(from, to, dir, limit = 5) {
    const now = new Date();
    const currentMins = now.getHours() * 60 + now.getMinutes();
    const serviceTag = (now.getDay() === 0 || now.getDay() === 6) ? 'å‡æ—¥' : 'å¹³æ—¥';

    const stationData = cache.metro.filter(item =>
        item.StationID === from && String(item.Direction) === dir && item.ServiceDay?.ServiceTag === serviceTag
    );

    const trains = [];
    stationData.forEach(route => {
        const dest = route.DestinationStationName?.Zh_tw || '';
        const isExpress = dest === 'è‡ºåŒ—è»Šç«™' || dest === 'A1';
        route.Timetables.forEach(tt => {
            const [h, m] = tt.DepartureTime.split(':').map(Number);
            let mins = h * 60 + m;
            if (mins < currentMins - 180) mins += 1440;
            trains.push({ time: tt.DepartureTime, mins, isExpress, dest });
        });
    });

    trains.sort((a, b) => a.mins - b.mins);
    const needFilter = (from === 'A6' || to === 'A6');
    return (needFilter ? trains.filter(t => !t.isExpress) : trains).filter(t => t.mins >= currentMins).slice(0, limit);
}

function getBikeValue(name, type) {
    const station = cache.stations?.find(s => s.StationName?.Zh_tw?.includes(name));
    if (!station) return null;
    const avail = cache.avail?.find(a => a.StationUID === station.StationUID);
    return type === 'rent' ? (avail?.AvailableRentBikes ?? 0) : (avail?.AvailableReturnBikes ?? 0);
}

function qtyClass(n) { return n === 0 ? 'qty-bad' : n <= 3 ? 'qty-warn' : 'qty-good'; }

function updateRouteDisplay(route) {
    const now = new Date();
    const currentMins = now.getHours() * 60 + now.getMinutes();
    const summaryEl = document.getElementById(`summary-${route.id}`);
    const detailEl = document.getElementById(`detailContent-${route.id}`);
    const cardEl = document.getElementById(`card-${route.id}`);
    if (!summaryEl || !detailEl) return;

    const metroStage = route.stages.find(s => s.type === 'metro');
    let nextTrain = null, countdown = null;

    if (metroStage) {
        const trains = getNextTrains(metroStage.from, metroStage.to, metroStage.dir);
        if (trains.length > 0) { nextTrain = trains[0]; countdown = nextTrain.mins - currentMins; }
    }

    const bikeStages = route.stages.filter(s => !s.type);
    let summaryHTML = '';

    if (route.bikeOnly) {
        const stage = bikeStages[0];
        const rentVal = getBikeValue(stage.rent[0].name, 'rent') ?? 0;
        const retVal = getBikeValue(stage.return[0].name, 'return') ?? 0;
        summaryHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="tag-rent text-xs px-2 py-1 font-medium">å€Ÿ <span class="${qtyClass(rentVal)} font-bold">${rentVal}</span> ${stage.rent[0].short}</span>
                    <span class="text-gray-300">â†’</span>
                    <span class="tag-return text-xs px-2 py-1 font-medium">é‚„ <span class="${qtyClass(retVal)} font-bold">${retVal}</span> ${stage.return[0].short}</span>
                </div>
                <span class="text-gray-400 text-sm">ğŸš² ${route.bikeTime}åˆ†</span>
            </div>
        `;
    } else {
        // åªæœ‰ã€Œè¨­å®šçš„ç›®æ¨™ç­æ¬¡ã€æ‰è§¸ç™¼ç·Šæ€¥æé†’ï¼ˆä¸æ˜¯è©²è·¯ç·šçš„ç¬¬ä¸€ç­è»Šï¼‰
        let targetCountdown = null;
        if (targetTrain && targetTrain.routeId === route.id) {
            const [h, m] = targetTrain.time.split(':').map(Number);
            let targetMins = h * 60 + m;
            if (targetMins < currentMins - 180) targetMins += 1440;
            targetCountdown = targetMins - currentMins;
        }
        const isUrgent = targetCountdown !== null && targetCountdown <= 3 && targetCountdown >= 0;
        if (isUrgent) {
            cardEl.classList.add('urgent-pulse');
            triggerVibration();
            showUrgentAlert(route.name, targetCountdown);
        } else {
            cardEl.classList.remove('urgent-pulse');
        }

        const stageLines = bikeStages.map((stage, idx) => {
            const num = idx === 0 ? 'â‘ ' : 'â‘¡';
            const rentItems = stage.rent.map(s => {
                const val = getBikeValue(s.name, 'rent') ?? 0;
                return `<span class="${qtyClass(val)} font-bold">${val}</span> ${s.short}`;
            }).join(' <span class="text-gray-300">/</span> ');
            const retTotal = stage.return.reduce((sum, s) => sum + (getBikeValue(s.name, 'return') ?? 0), 0);

            return `
                <div class="flex items-center gap-2 text-sm">
                    <span class="text-gray-400">${num}</span>
                    <span class="tag-rent text-xs px-2 py-1">å€Ÿ</span>
                    <span>${rentItems}</span>
                    <span class="text-gray-300">â†’</span>
                    <span class="tag-return text-xs px-2 py-1">é‚„</span>
                    <span class="${qtyClass(retTotal)} font-bold">${retTotal}</span>
                </div>
            `;
        }).join('');

        summaryHTML = `
            <div class="flex justify-between items-end gap-4">
                <div class="space-y-2">${stageLines}</div>
                <div class="text-right shrink-0">
                    ${nextTrain ? `
                        <div class="text-2xl font-semibold num ${isUrgent ? 'text-red-500' : 'text-gray-800'}">${nextTrain.time}</div>
                        <div class="text-sm ${isUrgent ? 'text-red-400' : 'text-gray-400'}">${countdown}åˆ†å¾Œ</div>
                    ` : '<div class="text-sm text-gray-400">ç„¡ç­æ¬¡</div>'}
                </div>
            </div>
        `;
    }
    summaryEl.innerHTML = summaryHTML;

    // Detail content
    let detailHTML = '';
    if (metroStage) {
        const trains = getNextTrains(metroStage.from, metroStage.to, metroStage.dir, 5);
        detailHTML += `
            <div class="mb-5">
                <div class="text-xs font-medium text-gray-500 mb-3">ğŸš‡ æ·é‹ ${metroStage.from} â†’ ${metroStage.to}</div>
                ${trains.length > 0 ? `<div class="space-y-2">${trains.map((t, i) => {
                    const diff = t.mins - currentMins;
                    const arriveTime = formatMinsToTime(t.mins + METRO_TIME);
                    const shareData = encodeURIComponent(JSON.stringify({ route: route.name, from: metroStage.from, to: metroStage.to, depart: t.time, arrive: arriveTime }));
                    const isTarget = targetTrain && targetTrain.routeId === route.id && targetTrain.time === t.time;
                    return `
                        <div class="flex justify-between items-center py-2 px-3 rounded-xl ${isTarget ? 'bg-amber-100/80 ring-2 ring-amber-400' : i === 0 ? 'bg-gray-100/60' : ''}">
                            <div>
                                <span class="num font-medium ${i === 0 ? 'text-lg' : 'text-gray-600'}">${t.time}</span>
                                <span class="text-gray-400 text-sm ml-2">â†’ ${arriveTime}</span>
                                ${isTarget ? '<span class="ml-2 text-amber-600 text-xs">ğŸ¯ ç›®æ¨™</span>' : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="${diff <= 3 ? 'text-red-500 font-semibold' : diff <= 5 ? 'text-amber-500' : 'text-gray-400'}">${diff}åˆ†</span>
                                ${isTarget ? '' : `<button class="text-xs px-2 py-1 rounded-lg bg-amber-100 text-amber-700 font-medium" onclick="event.stopPropagation(); setTarget('${route.id}', '${t.time}', '${route.name}', ${t.mins})">è¨­ç‚ºç›®æ¨™</button>`}
                                <button class="share-btn" onclick="event.stopPropagation(); shareTrain('${shareData}')">åˆ†äº«</button>
                            </div>
                        </div>
                    `;
                }).join('')}</div>` : '<div class="text-gray-400">ä»Šæ—¥å·²ç„¡ç­æ¬¡</div>'}
            </div>
        `;
    }

    bikeStages.forEach(stage => {
        detailHTML += `
            <div class="mb-4">
                <div class="text-xs font-medium text-gray-500 mb-3">${stage.label}</div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <div class="text-xs text-blue-600 font-medium mb-2">å€Ÿè»Š</div>
                        ${stage.rent.map(s => {
                            const val = getBikeValue(s.name, 'rent') ?? 0;
                            return `<div class="bg-blue-50 p-3 rounded-xl mb-2"><div class="text-xs text-gray-500">${s.short}</div><div class="text-2xl font-bold num ${qtyClass(val)}">${val}</div></div>`;
                        }).join('')}
                    </div>
                    <div>
                        <div class="text-xs text-emerald-600 font-medium mb-2">é‚„è»Š</div>
                        ${stage.return.map(s => {
                            const val = getBikeValue(s.name, 'return') ?? 0;
                            return `<div class="bg-emerald-50 p-3 rounded-xl mb-2"><div class="text-xs text-gray-500">${s.short}</div><div class="text-2xl font-bold num ${qtyClass(val)}">${val}</div></div>`;
                        }).join('')}
                    </div>
                </div>
            </div>
        `;
    });
    detailEl.innerHTML = detailHTML;
}

function formatTime(d) { return d.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false }); }
function formatMinsToTime(mins) { return `${String(Math.floor(mins/60)%24).padStart(2,'0')}:${String(mins%60).padStart(2,'0')}`; }
function formatTimeAgo(ts) { const m = Math.floor((Date.now()-ts)/60000); return m < 1 ? 'å‰›å‰›' : m < 60 ? `${m}åˆ†é˜å‰` : `${Math.floor(m/60)}å°æ™‚å‰`; }
function triggerVibration() { if ('vibrate' in navigator) navigator.vibrate([100, 50, 100]); }

async function shareTrain(encodedData) {
    const data = JSON.parse(decodeURIComponent(encodedData));
    const today = new Date().toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric' });
    const text = `ğŸš‡ é€šå‹¤è³‡è¨Š (${today})\nâ”â”â”â”â”â”â”â”â”â”\nğŸ“ ${data.route}\nğŸ• ${data.depart} å¾ ${data.from} ç«™ç™¼è»Š\nğŸ¯ é è¨ˆ ${data.arrive} æŠµé” ${data.to} ç«™\nâ”â”â”â”â”â”â”â”â”â”\næœ‰ç©ºçš„è©±å¯ä»¥ä¾†æ¥æˆ‘ï½`;

    if (navigator.share) { try { await navigator.share({ text }); return; } catch(e) { if (e.name === 'AbortError') return; } }
    try { await navigator.clipboard.writeText(text); showToast('âœ“ å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿'); }
    catch(e) { const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); showToast('âœ“ å·²è¤‡è£½'); }
}

function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }

function closeBanner() { document.getElementById('locationBanner').classList.add('hidden'); }

let urgentAlertShown = {};
function showUrgentAlert(routeName, countdown) {
    const key = `${routeName}-${countdown}`;
    if (urgentAlertShown[key]) return;
    urgentAlertShown[key] = true;
    const el = document.getElementById('urgentAlert');
    document.getElementById('urgentText').textContent = `${routeName} ${countdown}åˆ†é˜å¾Œç™¼è»Šï¼`;
    el.classList.remove('-translate-y-full');
    setTimeout(() => el.classList.add('-translate-y-full'), 8000);
}
function hideUrgentAlert() { document.getElementById('urgentAlert').classList.add('-translate-y-full'); }

function setTarget(routeId, time, routeName, mins) {
    targetTrain = { routeId, time, routeName, mins };
    document.getElementById('targetBanner').classList.remove('hidden');
    document.getElementById('targetInfo').textContent = `${routeName} ${time} ç™¼è»Š`;
    updateTargetBanner();
    updateAllRoutes(); // é‡æ–°æ¸²æŸ“ä»¥é¡¯ç¤ºç›®æ¨™æ¨™è¨˜
    showToast('âœ“ å·²è¨­å®šç›®æ¨™ç­æ¬¡');
}

function clearTarget() {
    targetTrain = null;
    document.getElementById('targetBanner').classList.add('hidden');
    updateAllRoutes();
    showToast('å·²å–æ¶ˆç›®æ¨™');
}

function updateTargetBanner() {
    if (!targetTrain) return;
    const now = new Date();
    const currentMins = now.getHours() * 60 + now.getMinutes();
    let mins = targetTrain.mins;
    // è™•ç†è·¨æ—¥
    if (mins < currentMins - 180) mins += 1440;
    const diff = mins - currentMins;

    if (diff < 0) {
        // ç­æ¬¡å·²é
        clearTarget();
        showToast('âš  ç›®æ¨™ç­æ¬¡å·²é');
        return;
    }

    document.getElementById('targetCountdown').textContent = diff;

    // æ ¹æ“šå‰©é¤˜æ™‚é–“æ”¹è®Šé¡è‰²
    const banner = document.getElementById('targetBanner').querySelector('.glass-card');
    const countdown = document.getElementById('targetCountdown');
    if (diff <= 3) {
        countdown.classList.remove('text-amber-600');
        countdown.classList.add('text-red-500');
    } else {
        countdown.classList.remove('text-red-500');
        countdown.classList.add('text-amber-600');
    }
}

function autoLocate() {
    const btn = document.getElementById('locateBtn'), text = document.getElementById('locateText'), icon = document.getElementById('locateIcon');
    if (!navigator.geolocation) { showToast('âŒ ä¸æ”¯æ´å®šä½'); return; }
    text.textContent = 'å®šä½ä¸­...'; icon.classList.add('spinning'); btn.disabled = true;

    const onSuccess = (pos) => {
        const nearest = findNearestLocation(pos.coords.latitude, pos.coords.longitude);
        // é¡¯ç¤ºç½®é ‚ banner
        document.getElementById('locationBanner').classList.remove('hidden');
        document.getElementById('bannerLocation').textContent = `åœ¨${nearest.location.name}é™„è¿‘ (${nearest.distance}m)ï¼Œæ¨è–¦è·¯ç·š`;
        // æ²å‹•åˆ°é ‚éƒ¨
        window.scrollTo({ top: 0, behavior: 'smooth' });
        highlightRoutes(nearest.key);
        text.textContent = 'é‡æ–°å®šä½'; icon.classList.remove('spinning'); btn.disabled = false;
    };

    const onError = (err) => {
        let msg = 'å®šä½å¤±æ•—';
        if (err.code === 1) msg = 'è«‹å…è¨±å®šä½æ¬Šé™';
        else if (err.code === 2) msg = 'ç„¡æ³•å–å¾—ä½ç½®';
        else if (err.code === 3) msg = 'å®šä½é€¾æ™‚';
        showToast(`âŒ ${msg}`);
        text.textContent = 'è‡ªå‹•å®šä½'; icon.classList.remove('spinning'); btn.disabled = false;
    };

    // å…ˆå˜—è©¦å¿«é€Ÿå®šä½ï¼Œå¤±æ•—å†ç”¨é«˜ç²¾åº¦
    navigator.geolocation.getCurrentPosition(onSuccess, (err) => {
        if (err.code === 3) {
            // é€¾æ™‚ï¼Œå˜—è©¦ä½ç²¾åº¦
            navigator.geolocation.getCurrentPosition(onSuccess, onError,
                { enableHighAccuracy: false, timeout: 15000, maximumAge: 300000 });
        } else {
            onError(err);
        }
    }, { enableHighAccuracy: true, timeout: 8000, maximumAge: 60000 });
}

function findNearestLocation(lat, lng) {
    let nearest = null, minDist = Infinity;
    for (const [key, loc] of Object.entries(LOCATIONS)) {
        const d = getDistance(lat, lng, loc.lat, loc.lng);
        if (d < minDist) { minDist = d; nearest = { key, location: loc, distance: Math.round(d) }; }
    }
    return nearest;
}

function getDistance(lat1, lng1, lat2, lng2) {
    const R = 6371000, dLat = (lat2-lat1)*Math.PI/180, dLng = (lng2-lng1)*Math.PI/180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function highlightRoutes(key) {
    document.querySelectorAll('.glass-card').forEach(c => c.classList.remove('ring-2', 'ring-indigo-400'));
    (LOCATION_ROUTES[key] || []).forEach(id => {
        const card = document.getElementById(`card-${id}`);
        if (card) { card.classList.add('ring-2', 'ring-indigo-400'); if (MORE_ROUTES.some(r => r.id === id) && !moreVisible) toggleMore(); }
    });
}
</script>
</body>
</html>
